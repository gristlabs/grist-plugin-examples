<!doctype html>
<html>
<head>
  <meta charset="utf8">
  <title>Jupyter Notebook</title>
  <script src="/grist-plugin-api.js"></script> 
  <script src="lib/grain-full.debug.js"></script> 
  <style>
    html, body, .full { width: 100%; height: 100%; margin: 0; }
    .full {
      border: none;
    }
  </style>
</head>
<body>
  <script>
    const dom = grainjs.dom;
    grist.ready();
    async function init() {
      try {
        if (!await thirdPartyCookieCheck()) {
          throw new Error('Using Jupyter Notebook in Grist requires Third-Party Cookies to be enabled');
        }
        const result = await grist.rpc.callRemoteFunc("startOrReuse@main.js");
        console.log("RESULT", result);
        document.body.appendChild(dom('iframe.full', {src: result}));
        setInterval(() => grist.rpc.postMessageForward("main.js", "ping"), 60000);
      } catch (e) {
        console.log("ERROR", e);
        document.body.appendChild(dom('div.full', e.message));
      }
    }
    function thirdPartyCookieCheck() {
      return new Promise((resolve) => {
        const iframe = dom('iframe', {src: 'third-party-cookie-check.html'}, dom.hide);
        const lis = dom.onElem(window, 'message', (ev) => {
          if (typeof ev.data === 'string' && ev.data.startsWith('third-party-cookie=')) {
            lis.dispose();
            document.body.removeChild(iframe);
            resolve(ev.data.split('=')[1] === 'true');
          }
        });
        document.body.appendChild(iframe);
      });
    }
    init();
  </script>

</body>
